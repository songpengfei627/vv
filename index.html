
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ™ºèƒ½ç‚¹é¤åŠ©æ‰‹</title>
  <style>
    /* åŸºæœ¬æ ·å¼ï¼ˆç®€æ´ï¼‰ */
    body{
      font-family: Arial, "Noto Sans SC", "Microsoft Yahei", sans-serif;
      background:#f7f7fb;
      margin:0;
      padding:0;
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh
    }
    #chat-container{
      width:360px;
      background:#fff;
      border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.08);
      display:flex;
      flex-direction:column;
      overflow:hidden
    }
    #chat-header{
      padding:12px 16px;
      background:linear-gradient(90deg,#4f8ef7,#6ad1ff);
      color:#fff;
      font-weight:600
    }
    #chat-log{
      height:420px;
      padding:12px;
      overflow:auto;
      background:#f2f6fb
    }
    .msg-wrapper{
      display:flex;
      gap:8px;
      margin:8px 0;
      align-items:flex-end
    }
    .msg-wrapper.user{
      justify-content:flex-end
    }
    .avatar{
      width:36px;
      height:36px;
      border-radius:50%;
      background:#d9e8ff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      color:#225
    }
    .avatar.bot{
      background:#3a7ef6;
      color:#fff
    }
    .bubble{
      max-width:70%;
      padding:8px 10px;
      border-radius:10px;
      line-height:1.4
    }
    .bubble.bot{
      background:#fff;
      border:1px solid #e1edf9
    }
    .bubble.user{
      background:#3a7ef6;
      color:#fff;
      border-radius:12px
    }
    #input-area{
      display:flex;
      padding:8px;
      border-top:1px solid #eee;
      background:#fff
    }
    #user-input{
      flex:1;
      padding:8px;
      border-radius:6px;
      border:1px solid #ddd;
      outline:none
    }
    #mic-btn,#send-btn{
      margin-left:6px;
      padding:8px 10px;
      border-radius:6px;
      border:none;
      background:#4f8ef7;
      color:#fff;
      cursor:pointer
    }
    #mic-btn[disabled],#send-btn[disabled]{
      opacity:.5;
      cursor:default
    }

    /* æ¨¡æ€ï¼šæœŸæœ› / æ»¡æ„åº¦ / è¡¨ç° */
    .modal-backdrop{
      position:fixed;
      left:0;
      top:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:999
    }
    .modal{
      width:320px;
      background:#fff;
      border-radius:10px;
      padding:14px;
      box-shadow:0 8px 30px rgba(0,0,0,.2)
    }
    .modal h3{
      margin:0 0 8px;
      font-size:16px
    }
    .modal .actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      margin-top:10px
    }
    .rating-row{
      display:flex;
      gap:8px;
      justify-content:center;
      margin:8px 0 12px
    }
    .rating-btn{
      width:32px;
      height:32px;
      border-radius:6px;
      border:1px solid #ddd;
      background:#f7f7fb;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
    }
    .rating-btn.selected{
      background:#4f8ef7;
      color:#fff;
      border-color:transparent
    }

    /* å°æç¤ºæ–‡æœ¬ */
    .muted{
      font-size:12px;
      color:#777;
      margin-top:6px
    }

    /* ä¸‰é¢˜å— */
    .expect-q{
      margin-top:4px;
      font-size:14px;
      font-weight:500;
    }
  </style>
</head>
<body>

<div id="chat-container">
  <div id="chat-header">æ™ºèƒ½ç‚¹é¤åŠ©æ‰‹</div>
  <div id="chat-log"></div>
  <div id="input-area">
    <input type="text" id="user-input" placeholder="è¯·æŒ‰ ğŸ¤ è¯´è¯..." />
    <button id="mic-btn">ğŸ¤</button>
    <button id="send-btn">â¤</button>
  </div>
</div>

<!-- æœŸæœ›æ‰“åˆ†å¼¹çª—ï¼š3é¢˜ -->
<div id="expectation-modal" class="modal-backdrop" style="display:none" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="æœåŠ¡æœŸæœ›">
    <h3>è¯·è¯„ä»·æ‚¨å¯¹æœ¬æ¬¡ç‚¹é¤åŠ©æ‰‹çš„é¢„æœŸ</h3>

    <div class="expect-q">1. æ‚¨é¢„æœŸç‚¹é¤åŠ©æ‰‹èƒ½å¤šä¹ˆç†è§£æ‚¨çš„éœ€æ±‚ï¼Ÿ</div>
    <div class="rating-row" id="expectation-rating-row-1">
      <button class="rating-btn" data-score="1">1</button>
      <button class="rating-btn" data-score="2">2</button>
      <button class="rating-btn" data-score="3">3</button>
      <button class="rating-btn" data-score="4">4</button>
      <button class="rating-btn" data-score="5">5</button>
      <button class="rating-btn" data-score="6">6</button>
      <button class="rating-btn" data-score="7">7</button>
    </div>

    <div class="expect-q">2. æ‚¨é¢„æœŸç‚¹é¤åŠ©æ‰‹æœ‰å¤šå¯é ï¼Ÿ</div>
    <div class="rating-row" id="expectation-rating-row-2">
      <button class="rating-btn" data-score="1">1</button>
      <button class="rating-btn" data-score="2">2</button>
      <button class="rating-btn" data-score="3">3</button>
      <button class="rating-btn" data-score="4">4</button>
      <button class="rating-btn" data-score="5">5</button>
      <button class="rating-btn" data-score="6">6</button>
      <button class="rating-btn" data-score="7">7</button>
    </div>

    <div class="expect-q">3. æ‚¨é¢„æœŸç‚¹é¤åŠ©æ‰‹æ¨èçš„å†…å®¹æœ‰å¤šä¹ˆç¬¦åˆæ‚¨çš„åå¥½ï¼Ÿ</div>
    <div class="rating-row" id="expectation-rating-row-3">
      <button class="rating-btn" data-score="1">1</button>
      <button class="rating-btn" data-score="2">2</button>
      <button class="rating-btn" data-score="3">3</button>
      <button class="rating-btn" data-score="4">4</button>
      <button class="rating-btn" data-score="5">5</button>
      <button class="rating-btn" data-score="6">6</button>
      <button class="rating-btn" data-score="7">7</button>
    </div>

    <div class="muted">1 = é¢„æœŸå¾ˆä½ï¼Œ7 = é¢„æœŸå¾ˆé«˜</div>
    <div class="actions">
      <button id="expectation-submit" style="background:#4f8ef7;color:#fff;border:none;padding:8px 10px;border-radius:6px">æäº¤</button>
    </div>
  </div>
</div>

<!-- æ»¡æ„åº¦è¯„åˆ†å¼¹çª— -->
<div id="rating-modal" class="modal-backdrop" style="display:none" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="æ»¡æ„åº¦è¯„åˆ†">
    <h3>è¯·ä¸ºæœ¬æ¬¡æœåŠ¡æ‰“åˆ†</h3>
    <div class="rating-row" id="rating-row">
      <button class="rating-btn" data-score="1">1</button>
      <button class="rating-btn" data-score="2">2</button>
      <button class="rating-btn" data-score="3">3</button>
      <button class="rating-btn" data-score="4">4</button>
      <button class="rating-btn" data-score="5">5</button>
      <button class="rating-btn" data-score="6">6</button>
      <button class="rating-btn" data-score="7">7</button>
    </div>
    <div class="muted">1 = ä¸€ç‚¹éƒ½ä¸æ»¡æ„ï¼Œ7 = éå¸¸æ»¡æ„</div>
    <div class="actions" style="margin-top:10px">
      <button id="rating-submit" style="background:#4f8ef7;color:#fff;border:none;padding:8px 10px;border-radius:6px">æäº¤è¯„åˆ†</button>
    </div>
  </div>
</div>

<!-- æœåŠ¡è¡¨ç°å¼¹çª—ï¼š3é¢˜ï¼ˆäº‹åæ„ŸçŸ¥ï¼‰ -->
<div id="performance-modal" class="modal-backdrop" style="display:none" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="æœåŠ¡è¡¨ç°è¯„ä»·">
    <h3>è¯·è¯„ä»·æœ¬æ¬¡ç‚¹é¤åŠ©æ‰‹çš„å®é™…è¡¨ç°</h3>

    <div class="expect-q">1. æ‚¨è®¤ä¸ºè¯¥ç‚¹é¤åŠ©æ‰‹æœ‰å¤šä¹ˆç†è§£æ‚¨çš„éœ€æ±‚ï¼Ÿ</div>
    <div class="rating-row" id="performance-rating-row-1">
      <button class="rating-btn" data-score="1">1</button>
      <button class="rating-btn" data-score="2">2</button>
      <button class="rating-btn" data-score="3">3</button>
      <button class="rating-btn" data-score="4">4</button>
      <button class="rating-btn" data-score="5">5</button>
      <button class="rating-btn" data-score="6">6</button>
      <button class="rating-btn" data-score="7">7</button>
    </div>

    <div class="expect-q">2. æ‚¨è®¤ä¸ºè¯¥ç‚¹é¤åŠ©æ‰‹æœ‰å¤šå¯é ï¼Ÿ</div>
    <div class="rating-row" id="performance-rating-row-2">
      <button class="rating-btn" data-score="1">1</button>
      <button class="rating-btn" data-score="2">2</button>
      <button class="rating-btn" data-score="3">3</button>
      <button class="rating-btn" data-score="4">4</button>
      <button class="rating-btn" data-score="5">5</button>
      <button class="rating-btn" data-score="6">6</button>
      <button class="rating-btn" data-score="7">7</button>
    </div>

    <div class="expect-q">3. æ‚¨è®¤ä¸ºè¯¥ç‚¹é¤åŠ©æ‰‹æ¨èçš„å†…å®¹æœ‰å¤šä¹ˆç¬¦åˆæ‚¨çš„åå¥½ï¼Ÿ</div>
    <div class="rating-row" id="performance-rating-row-3">
      <button class="rating-btn" data-score="1">1</button>
      <button class="rating-btn" data-score="2">2</button>
      <button class="rating-btn" data-score="3">3</button>
      <button class="rating-btn" data-score="4">4</button>
      <button class="rating-btn" data-score="5">5</button>
      <button class="rating-btn" data-score="6">6</button>
      <button class="rating-btn" data-score="7">7</button>
    </div>

    <div class="muted">1 = ä¸€ç‚¹éƒ½ä¸ï¼Œ7 = éå¸¸</div>
    <div class="actions">
      <button id="performance-submit" style="background:#4f8ef7;color:#fff;border:none;padding:8px 10px;border-radius:6px">æäº¤</button>
    </div>
  </div>
</div>

<script>
/* ======================== åŸå§‹é€»è¾‘ï¼ˆåšäº†å¿…è¦è°ƒæ•´ï¼‰ ======================== */

// 0) æ›¿æ¢ä¸ºä½ çš„ Formspree ç«¯ç‚¹
const FORM_ENDPOINT = 'https://formspree.io/f/mpwjlwbk';

// DOM
const chatLog  = document.getElementById('chat-log');
const userInput= document.getElementById('user-input');
const micBtn   = document.getElementById('mic-btn');
const sendBtn  = document.getElementById('send-btn');

const expectationModal = document.getElementById('expectation-modal');
const expectationSubmit= document.getElementById('expectation-submit');
const expectationRatingRow1 = document.getElementById('expectation-rating-row-1');
const expectationRatingRow2 = document.getElementById('expectation-rating-row-2');
const expectationRatingRow3 = document.getElementById('expectation-rating-row-3');

const ratingModal = document.getElementById('rating-modal');
const ratingRow   = document.getElementById('rating-row');
const ratingSubmit= document.getElementById('rating-submit');

const performanceModal = document.getElementById('performance-modal');
const performanceSubmit = document.getElementById('performance-submit');
const performanceRatingRow1 = document.getElementById('performance-rating-row-1');
const performanceRatingRow2 = document.getElementById('performance-rating-row-2');
const performanceRatingRow3 = document.getElementById('performance-rating-row-3');

// stages: 0 -> é¦–é—®ï¼›1 -> è¯¢èœç³»ï¼›2 -> å¿Œå£ï¼›
// 3 -> å·²æ”¶â€œæœŸæœ›â€ï¼›4 -> å·²æ”¶â€œæ»¡æ„åº¦â€ï¼›5 -> å·²æ”¶â€œæœåŠ¡è¡¨ç°å¹¶ç»“æŸâ€
let stage = 0;

// ç¼“å†² & ä¸ŠæŠ¥æ§åˆ¶
const userMessages = [];
let submitted = false;
function generateConvoId() {
  const num = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
  return 'vv' + num;
}
const convoId = generateConvoId();

/* ---------- TTS: Web Speech API ---------- */
const synth = window.speechSynthesis || null;
let zhVoice = null;
function pickZhVoice() {
  if (!synth) return;
  const voices = synth.getVoices();
  if (!voices || !voices.length) return;
  zhVoice = voices.find(v => v.lang && v.lang.toLowerCase().startsWith('zh'))
            || voices.find(v => /chinese/i.test(v.name))
            || voices[0];
}
if (synth) {
  synth.onvoiceschanged = pickZhVoice;
  pickZhVoice();
}
function speakBot(text) {
  if (!synth) return;
  const plain = text.replace(/<[^>]+>/g, '');
  synth.cancel();
  const utter = new SpeechSynthesisUtterance(plain);
  if (zhVoice) utter.voice = zhVoice;
  utter.lang = zhVoice?.lang || 'zh-CN';
  utter.rate = 1;
  utter.pitch = 1;
  synth.speak(utter);
}

/* ---------- helper: chat bubble ---------- */
function createMsg(text, sender){
  const wrap   = document.createElement('div');
  wrap.className = 'msg-wrapper ' + sender;

  const avatar = document.createElement('div');
  avatar.className = 'avatar ' + sender;
  avatar.textContent = sender === 'bot' ? 'æ™º' : 'æ‚¨';

  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + sender;
  bubble.innerHTML = text.replace(/\n/g,'<br>');

  if(sender === 'bot'){
    wrap.appendChild(avatar);
    wrap.appendChild(bubble);
    speakBot(text);
  }else{
    wrap.appendChild(bubble);
    wrap.appendChild(avatar);
  }
  chatLog.appendChild(wrap);
  chatLog.scrollTop = chatLog.scrollHeight;
}

/* ---------- Init ---------- */
window.onload = ()=>{
  createMsg('æˆ‘æ˜¯æ‚¨çš„æ™ºèƒ½ç‚¹é¤åŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚è¯·é—®éœ€è¦æˆ‘å¸®æ‚¨æ¨èé¤å“å—ï¼Ÿä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥è¾“å…¥â€œæ¨èåŒäººé¤â€ã€‚','bot');

  // ç¦æ­¢æ‰‹åŠ¨è¾“å…¥
  userInput.readOnly = true;
  userInput.addEventListener('keydown', e => e.preventDefault());
};

/* ---------- Speech Recognition ---------- */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recognition = SpeechRecognition ? new SpeechRecognition() : null;
if(recognition){
  recognition.lang = 'zh-CN';
  recognition.continuous = false;
}
micBtn.onclick = () => {
  if(!recognition){ alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«'); return; }
  recognition.start();
  micBtn.textContent = 'âº';
};
if(recognition){
  recognition.onresult = (e) => {
    const transcript = e.results[0][0].transcript;
    userInput.value = transcript;
    micBtn.textContent = 'ğŸ¤';
  };
  recognition.onerror = () => { micBtn.textContent = 'ğŸ¤'; };
}
sendBtn.onclick = sendMessage;
userInput.onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };

/* ---------- ç»“æŸæ—¶ä¸€æ¬¡æ€§æäº¤ï¼ˆé™é»˜ï¼‰ï¼šæŒ‰é˜¶æ®µæ‹†åˆ— ---------- */
async function submitAllMessagesOnce() {
  if (submitted) return;
  submitted = true;

  const startedAt = performance.timing?.navigationStart
    ? new Date(performance.timing.navigationStart).toISOString()
    : null;

  const stageBuckets = {};
  userMessages.forEach(m => {
    const key = String(m.stage);
    if (!stageBuckets[key]) stageBuckets[key] = [];
    stageBuckets[key].push(m.text);
  });

  const payload = {
    convoId,
    path: location.pathname,
    startedAt,
    finishedAt: new Date().toISOString(),
    userAgent: navigator.userAgent,
    all_messages: userMessages
  };

  Object.keys(stageBuckets)
    .sort((a,b)=>+a-+b)
    .forEach(stageKey => {
      const joined = stageBuckets[stageKey].join(' | ');
      payload[`stage${stageKey}_text`] = joined;
    });

  try {
    const res = await fetch(FORM_ENDPOINT, {
      method: 'POST',
      headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (res.ok) return;
  } catch (e) {
    console.debug('Direct JSON submit failed (silenced):', e);
  }

  try {
    await fetch(FORM_ENDPOINT, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
  } catch (e2) {
    console.debug('no-cors submit failed (silenced):', e2);
  }
}

/* ---------- Bot response ä¿®æ”¹ä»¥æ”¯æŒæœŸæœ› & è¯„åˆ†æµç¨‹ ---------- */
function botRespond() {
  if (stage === 0) {
    createMsg('æœ¬åº—ä¸»æ‰“èåˆèœç³»ï¼Œå¯é€‰ï¼šå·èœ / ç²¤èœ / æ·®æ‰¬èœ / ç´ é£Ÿç­‰ã€‚æ‚¨æ›´åå¥½å“ªç§å£å‘³å‘¢ï¼Ÿ', 'bot');
    stage = 1;
    return;
  }
  if (stage === 1) {
    createMsg('å¥½çš„ï¼Œæˆ‘è¿™è¾¹è®°å½•ä¸‹æ¥äº†ï½è¯·é—®æœ‰æ²¡æœ‰å¿Œå£æˆ–ä¸åƒçš„é£Ÿæå‘¢ï¼Ÿæˆ‘æ¥ä¸ºæ‚¨æ¨èåˆé€‚çš„å¥—é¤å“¦ï¼', 'bot');
    stage = 2;
    return;
  }
  if (stage === 2) {
    // è¿›å…¥â€œæœŸæœ›æ‰“åˆ†å¼¹çª—â€
    openExpectationModal();
    return;
  }
  // åé¢é˜¶æ®µä¸å†é€šè¿‡ botRespond è§¦å‘
}

/* ---------- send message ---------- */
async function sendMessage(){
  const text = userInput.value.trim();
  if(!text) return;

  createMsg(text,'user');
  userInput.value = '';
  sendBtn.disabled = true;

  // è®°å½•ç”¨æˆ·æ¶ˆæ¯ï¼ˆå½“å‰çš„ stage è¡¨ç¤ºè¿™æ¡ user message å‘ç”Ÿæ—¶çš„é˜¶æ®µï¼‰
  userMessages.push({ text, stage, ts: new Date().toISOString() });

  setTimeout(()=>{
    sendBtn.disabled = false;
    botRespond();
  }, 800);
}

/* ================== æœŸæœ›æ‰“åˆ†å¼¹çª—ç›¸å…³ï¼ˆä¸‰ä¸ªé¢˜ï¼‰ ================== */
let expectationScore1 = null;
let expectationScore2 = null;
let expectationScore3 = null;

function resetExpectationButtons(){
  expectationScore1 = expectationScore2 = expectationScore3 = null;
  [expectationRatingRow1, expectationRatingRow2, expectationRatingRow3].forEach(row=>{
    Array.from(row.querySelectorAll('.rating-btn'))
      .forEach(b => b.classList.remove('selected'));
  });
}

function openExpectationModal(){
  expectationModal.style.display = 'flex';
  expectationModal.setAttribute('aria-hidden','false');
  micBtn.disabled = true;
  sendBtn.disabled = true;
  resetExpectationButtons();
}

// å•ç‹¬ç»™ä¸‰ä¸ªè¡Œç»‘å®šç‚¹å‡»
function bindExpectationRow(row, index){
  row.addEventListener('click', (e) => {
    const btn = e.target.closest('.rating-btn');
    if (!btn) return;
    const score = btn.dataset.score;
    if (index === 1) expectationScore1 = score;
    if (index === 2) expectationScore2 = score;
    if (index === 3) expectationScore3 = score;
    Array.from(row.querySelectorAll('.rating-btn'))
      .forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
  });
}
bindExpectationRow(expectationRatingRow1, 1);
bindExpectationRow(expectationRatingRow2, 2);
bindExpectationRow(expectationRatingRow3, 3);

// ç”¨æˆ·æäº¤æœŸæœ›è¯„åˆ†ï¼ˆ3é¢˜å¿…é¡»éƒ½é€‰ï¼‰
expectationSubmit.onclick = () => {
  if (!expectationScore1 || !expectationScore2 || !expectationScore3) {
    alert('è¯·å®Œæˆä¸‰ä¸ªæœŸæœ›è¯„åˆ†é¢˜ç›®ï¼ˆ1-7ï¼‰åå†æäº¤ã€‚');
    return;
  }
  // è®°å½•ä¸‰æ¡æœŸæœ›ï¼ˆstage 3ï¼‰
  userMessages.push({
    text: `æœŸæœ›_ç†è§£éœ€æ±‚ï¼š${expectationScore1}`,
    stage: 3,
    ts: new Date().toISOString()
  });
  userMessages.push({
    text: `æœŸæœ›_å¯é æ€§ï¼š${expectationScore2}`,
    stage: 3,
    ts: new Date().toISOString()
  });
  userMessages.push({
    text: `æœŸæœ›_ç¬¦åˆåå¥½ï¼š${expectationScore3}`,
    stage: 3,
    ts: new Date().toISOString()
  });

  closeExpectationModal();

  // æœåŠ¡å¤±è´¥ç»“æœ + 10 ç§’åå†ç»™æ»¡æ„åº¦æµ‹é‡
  setTimeout(()=> {
    const failMsg = 'å¾ˆæŠ±æ­‰ï¼Œæˆ‘æ²¡èƒ½ç†è§£æ‚¨çš„éœ€æ±‚ï¼ŒæœŸå¾…ä¸‹æ¬¡ä¸ºæ‚¨æ›´å¥½çš„æœåŠ¡ï¼ˆè¯·ç¨å€™å‡ ç§’ï¼Œå®Œæˆæ»¡æ„åº¦è¯„ä»·å¹¶æŸ¥çœ‹å¯¹è¯ä»£ç åå†å…³é—­æœ¬é¡µé¢ï¼‰ã€‚';
    createMsg(failMsg, 'bot');
    userMessages.push({
      text: '[BOT] ' + failMsg.replace(/<[^>]+>/g,''),
      stage: 3,
      ts: new Date().toISOString(),
      from: 'bot'
    });

    // 10 ç§’åå¼¹å‡ºæ»¡æ„åº¦è¯„åˆ†
    setTimeout(()=> openRatingModal(), 10000);
  }, 600);

  stage = 3;
};

function closeExpectationModal(){
  expectationModal.style.display = 'none';
  expectationModal.setAttribute('aria-hidden','true');
  micBtn.disabled = false;
  sendBtn.disabled = false;
}

/* ================== æ»¡æ„åº¦è¯„åˆ†å¼¹çª—ç›¸å…³ ================== */
let currentScore = null;

function openRatingModal(){
  ratingModal.style.display = 'flex';
  ratingModal.setAttribute('aria-hidden','false');
  micBtn.disabled = true;
  sendBtn.disabled = true;
  // reset selection
  currentScore = null;
  Array.from(ratingRow.querySelectorAll('.rating-btn'))
    .forEach(b => b.classList.remove('selected'));
}

ratingRow.addEventListener('click', (e) => {
  const btn = e.target.closest('.rating-btn');
  if (!btn) return;
  currentScore = btn.dataset.score;
  Array.from(ratingRow.querySelectorAll('.rating-btn'))
    .forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
});

ratingSubmit.onclick = () => {
  if (!currentScore) {
    alert('è¯·é€‰æ‹©ä¸€ä¸ªæ»¡æ„åº¦è¯„åˆ†ï¼ˆ1-7ï¼‰å†æäº¤ã€‚');
    return;
  }
  // è®°å½•æ»¡æ„åº¦ï¼ˆstage 4ï¼‰
  userMessages.push({
    text: `æ»¡æ„åº¦è¯„åˆ†ï¼š${currentScore}`,
    stage: 4,
    ts: new Date().toISOString()
  });

  closeRatingModal();

  // æç¤ºæ¥ä¸‹æ¥è¯„æœåŠ¡è¡¨ç° + æ‰“å¼€è¡¨ç°å¼¹çª—ï¼ˆä¸æ˜¾ç¤ºåˆ†æ•°ï¼‰
  setTimeout(()=> {
    const msg = 'æ„Ÿè°¢æ‚¨çš„è¯„åˆ†ï¼Œæ¥ä¸‹æ¥è¯·è¯„ä»·æœ¬æ¬¡ç‚¹é¤åŠ©æ‰‹çš„å…·ä½“è¡¨ç°ã€‚';
    createMsg(msg, 'bot');
    userMessages.push({
      text: '[BOT] ' + msg,
      stage: 4,
      ts: new Date().toISOString(),
      from: 'bot'
    });
    setTimeout(()=> openPerformanceModal(), 800);
  }, 400);

  stage = 4;
};

function closeRatingModal(){
  ratingModal.style.display = 'none';
  ratingModal.setAttribute('aria-hidden','true');
  micBtn.disabled = false;
  sendBtn.disabled = false;
}

/* ================== æœåŠ¡è¡¨ç°å¼¹çª—ï¼ˆä¸‰ä¸ªé¢˜ï¼‰ ================== */
let performanceScore1 = null;
let performanceScore2 = null;
let performanceScore3 = null;

function resetPerformanceButtons(){
  performanceScore1 = performanceScore2 = performanceScore3 = null;
  [performanceRatingRow1, performanceRatingRow2, performanceRatingRow3].forEach(row=>{
    Array.from(row.querySelectorAll('.rating-btn'))
      .forEach(b => b.classList.remove('selected'));
  });
}

function openPerformanceModal(){
  performanceModal.style.display = 'flex';
  performanceModal.setAttribute('aria-hidden','false');
  micBtn.disabled = true;
  sendBtn.disabled = true;
  resetPerformanceButtons();
}

// ç»‘å®šä¸‰ä¸ªè¡¨ç°è¡Œçš„ç‚¹å‡»
function bindPerformanceRow(row, index){
  row.addEventListener('click', (e) => {
    const btn = e.target.closest('.rating-btn');
    if (!btn) return;
    const score = btn.dataset.score;
    if (index === 1) performanceScore1 = score;
    if (index === 2) performanceScore2 = score;
    if (index === 3) performanceScore3 = score;
    Array.from(row.querySelectorAll('.rating-btn'))
      .forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
  });
}
bindPerformanceRow(performanceRatingRow1, 1);
bindPerformanceRow(performanceRatingRow2, 2);
bindPerformanceRow(performanceRatingRow3, 3);

// æäº¤è¡¨ç°
performanceSubmit.onclick = () => {
  if (!performanceScore1 || !performanceScore2 || !performanceScore3) {
    alert('è¯·å®Œæˆä¸‰ä¸ªæœåŠ¡è¡¨ç°é¢˜ç›®ï¼ˆ1-7ï¼‰åå†æäº¤ã€‚');
    return;
  }

  // è®°å½•ä¸‰æ¡è¡¨ç°ï¼ˆstage 5ï¼‰
  userMessages.push({
    text: `è¡¨ç°_ç†è§£éœ€æ±‚ï¼š${performanceScore1}`,
    stage: 5,
    ts: new Date().toISOString()
  });
  userMessages.push({
    text: `è¡¨ç°_å¯é æ€§ï¼š${performanceScore2}`,
    stage: 5,
    ts: new Date().toISOString()
  });
  userMessages.push({
    text: `è¡¨ç°_ç¬¦åˆåå¥½ï¼š${performanceScore3}`,
    stage: 5,
    ts: new Date().toISOString()
  });

  closePerformanceModal();

  // æœ€ç»ˆç»“æŸè¯­ + æœåŠ¡ä»£ç  + ä¸€æ¬¡æ€§ä¸ŠæŠ¥ï¼ˆä¸å±•ç¤ºä»»ä½•åˆ†æ•°ï¼‰
  setTimeout(()=> {
    const finalMsg = `ğŸ‰ æ„Ÿè°¢æ‚¨çš„æ‰€æœ‰åé¦ˆï¼Œæœ¬è½®å¯¹è¯å·²ç»“æŸï¼Œæ‚¨çš„æœåŠ¡ä»£ç æ˜¯ <b>${convoId}</b>ï¼Œè¯·è¿”å›é—®å·ç»§ç»­ä½œç­”ã€‚`;
    createMsg(finalMsg, 'bot');
    userMessages.push({
      text: '[BOT] ' + finalMsg.replace(/<[^>]+>/g,''),
      stage: 5,
      ts: new Date().toISOString(),
      from: 'bot'
    });

    // ä¸Šä¼ 
    submitAllMessagesOnce();
    // ç½®ä¸ºå·²ç»“æŸ
    stage = 5;
    micBtn.disabled = true;
    sendBtn.disabled = true;
  }, 600);
};

function closePerformanceModal(){
  performanceModal.style.display = 'none';
  performanceModal.setAttribute('aria-hidden','true');
  micBtn.disabled = false;
  sendBtn.disabled = false;
}

/* =========== é€‚é…ï¼šå¦‚æœç”¨æˆ·ç›´æ¥è§¦å‘ botRespond åˆ° stage=2ï¼ˆä¾‹å¦‚å¿«é€Ÿè¿ç»­æŒ‰ï¼‰ =========== */
/* ä¿æŒåŸæœ¬ sendMessage / botRespond æµç¨‹ï¼›å½“ stage=2 æ—¶ä¼šè‡ªåŠ¨å¼¹æœŸæœ›çª—å£ã€‚ */

</script>
</body>
</html>



